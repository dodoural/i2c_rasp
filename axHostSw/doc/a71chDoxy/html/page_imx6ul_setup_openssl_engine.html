<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>A71CH Host Sw: i.MX6UL: Setting up OpenSSL Engine</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">A71CH Host Sw
   &#160;<span id="projectnumber">v01.05.00</span>
   </div>
   <div id="projectbrief">NXP Semiconductors</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('page_imx6ul_setup_openssl_engine.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">i.MX6UL: Setting up OpenSSL Engine </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ul>
<li>DocRevision : 0.96</li>
<li>Date : 2018-09-07</li>
</ul>
<p>This section explains how to compile the A71CH OpenSSL Engine and associated example programs. It details how to install binaries, scripts and associated key material on the embedded platform.</p>
<dl class="section note"><dt>Note</dt><dd><b>NXP makes available an MCIMX6UL-EVK(B) specific SD card image that comes with native development tools and both the A71CH HostLib and OpenSSL engine pre-installed. Jump to step (5) when using this SD card.</b></dd>
<dd>
First consult <a class="el" href="page_imx6ul.html">Setup i.MX6ULEVK</a> for instructions on setting up a cross compilation environment and compiling the A71CH Host SW.</dd>
<dd>
In case a native compilation environment is available on the Embedded Target one could skip setting up the cross compilation environment. Jump to step (4) below and unpack the full source code tree in /home/root/axHostSw instead, compile the binaries as outlined in step (2) and (3) and create the two symbolic links.</dd>
<dd>
To ensure the OpenSSL engine is used at run-time by an application be sure to define the flag <code>OPENSSL_LOAD_CONF</code> when compiling the application. Please check the makefiles provided with the examples for further details. More information on the OpenSSL engine is available in the document 'A71CH OpenSSL Engine [um4334**]'.</dd></dl>
<h1><a class="anchor" id="autotoc_md8"></a>
(1) Pre-conditions</h1>
<p>The A71CH Host SW has been unpacked in a directory axHostSw. The development PC has been prepared for cross compiling for the MCIMX6UL-EVKB board. The unpacked SW tree looks like </p><pre class="fragment">&gt; tree -L 2 axHostSw
axHostSw
├── doc
│   ├── a71chDoxy
│   ├── doxyScripts
│   └── iMX6UL_A71CH.md
├── hostLib
│   ├── a71ch
│   ├── api
│   ├── embSeEngine
│   ├── libCommon
│   ├── platform
│   ├── rjct
│   └── tstUtil
└── linux
    ├── buildA71CH.sh
    └── Makefile_A71CH
</pre><p>Use cmake in cross compilation mode to create make files and applications for the embedded platform. Invoke make and install the A71CH shared library (libA71CH_i2c.so.1.4.0), HLSE shared library (libHLSE_A71CH_i2c.so.1.0.0) and associated header files in a standard system location of the SDK target system root. </p><pre class="fragment">"First prepare environment for cross-compilation, e.g."
source /opt/fsl-imx-fb/4.9.11-1.0.0/environment-setup-cortexa7hf-neon-poky-linux-gnueabi
cd &lt;your_path&gt;/axHostSw
mkdir build_i2c_cc
tree -L 2 axHostSw
    axHostSw
    ├── build_i2c_cc    
    ├── doc
    │   ├── a71chDoxy
    │   ├── doxyScripts
    │   └── iMX6UL_A71CH.md
    ├── hostLib
    │   ├── a71ch
    │   ├── api
    │   ├── embSeEngine
    │   ├── libCommon
    │   ├── platform
    │   ├── rjct
    │   └── tstUtil
    └── linux
       ├── buildA71CH.sh
       └── Makefile_A71CH
cd build_i2c_cc
cmake -DUSE_SMCOM_I2C=ON -DCMAKE_TOOLCHAIN_FILE=../hostLib/ToolchainFile_imx6.cmake ../hostLib
make
sudo make DESTDIR=$SDKTARGETSYSROOT install
</pre><h1><a class="anchor" id="autotoc_md9"></a>
(2) Cross compile</h1>
<p>To create the OpenSSL Engine shared library, execute the following command </p><pre class="fragment">&gt; cd axHostSw/linux
&gt; make -f Makefile_A71CH engine app=A71CH_LINKED_ENGINE conn=i2c platf=imx
</pre><p>To successfully run the OpenSSL examples the A71CH must be provisioned with appropriate credentials. Provisioning is done with the A71CH configure application, which is created as follows: </p><pre class="fragment">&gt; make -f Makefile_A71CH default app=A71CH_CONFIG conn=i2c platf=imx
</pre><p>After executing the above make commands the axHostSw/linux directory will contain (at least): </p><pre class="fragment">&gt; tree axHostSw/linux
axHostSw/linux
├── a71chConfig_i2c_imx
├── buildA71CH.sh
├── libe2a71chi2c.so
├── libe2a71chi2c.so.1.0.0
└── Makefile_A71CH
</pre><p>The A71CH Host SW also contains two example applications using the OpenSSL Engine. To compile these examples go first into directory <code>axHostSw/hostLib/embSeEngine/a71chEx</code> and invoke the following commands: </p><pre class="fragment">&gt; cd axHostSw/hostLib/embSeEngine/a71chEx
&gt; make -f Makefile_a71chTlsClient conn=i2c platf=imx ENGINE_HINT=ON
&gt; make -f Makefile_a71chEcDhKa conn=i2c platf=imx ENGINE_HINT=ON
</pre><p>After executing these commands the <code>axHostSw/hostLib/embSeEngine/a71chEx</code> directory will contain the following files: </p><pre class="fragment">&gt; tree axHostSw/hostLib/embSeEngine/a71chEx
axHostSw/hostLib/embSeEngine/a71chEx
├── a71chEcDhKa
├── a71chEcDhKa.c
├── a71chEcDhKa.o
├── a71chTlsClient
├── a71chTlsClient.c
├── a71chTlsClient.o
├── Makefile_a71chEcDhKa
└── Makefile_a71chTlsClient
</pre><dl class="section note"><dt>Note</dt><dd>To ensure the OpenSSL engine is used at run-time by an application be sure to define the flag <code>OPENSSL_LOAD_CONF</code> when compiling the application. Please check the makefiles provided with the examples for further details. More information on the OpenSSL engine is available in the document 'A71CH OpenSSL Engine [um4334**]'.</dd></dl>
<h1><a class="anchor" id="autotoc_md10"></a>
(3) Packaging OpenSSL Engine related files for transfer to embedded platform.</h1>
<p>To be able to execute the OpenSSL Engine examples one needs to transfer binaries, scripts and associated key material to the embedded platform. The script <code>axHostSw/linux/packageA71chOpenSslEngine.sh</code> will collect these files and put them in a compressed tar archive <code>A71CH_Engine.tgz</code>. The script <b>must</b> be invoked from the <code>axHostSw/linux</code> directory. </p><pre class="fragment">&gt; cd axHostSw/linux
&gt; ./packageA71chOpenSslEngine.sh
</pre><p>Now transfer <code>A71CH_Engine.tgz</code> to the embedded platform (e.g. using scp, ftp or a USB stick).</p>
<p>In addition one must transfer the shared libraries created on the SDK target system root to the embedded platform. Assuming default locations of the cross compiler, this implies copying the content of the directories </p><pre class="fragment">/opt/fsl-imx-fb/4.9.11-1.0.0/sysroots/cortexa7hf-neon-poky-linux-gnueabi/usr/local/bin
/opt/fsl-imx-fb/4.9.11-1.0.0/sysroots/cortexa7hf-neon-poky-linux-gnueabi/usr/local/lib
</pre><p>To the equivalent directories on the embedded platform. </p><pre class="fragment">/usr/local/bin
/usr/local/lib
</pre><dl class="section note"><dt>Note</dt><dd>The following steps are executed on the embedded platform</dd></dl>
<h1><a class="anchor" id="autotoc_md11"></a>
(4) Embedded platform preparation</h1>
<p>Connect with a shell to the embedded target. In case of the standard Yocto target <code>core-image-full-cmdline</code> connect as user <code>root</code> and go into directory <code>/home/root</code>. Move the archive <code>A71CH_Engine.tgz</code> (created in step '3') into this <code>/home/root</code> directory and unpack it. </p><pre class="fragment">&gt;&gt; cd /home/root
&gt;&gt; ls
... A71CH_Engine.tgz ...
&gt;&gt; tar xzvf A71CH_Engine.tgz
</pre><p>This will unpack the following set of files: </p><pre class="fragment">./hostLib/embSeEngine/a71chDemo/ecc/
./hostLib/embSeEngine/a71chDemo/ecc/ecc_key_kp_0.pem
...
./hostLib/embSeEngine/a71chDemo/ecc/ecc_key_pub_pubonly_0.pem
./hostLib/embSeEngine/a71chDemo/ecc/prime256v1.pem
./hostLib/embSeEngine/a71chDemo/ecc/remote_ecc_kp.pem
./hostLib/embSeEngine/a71chDemo/ecc/tls_client.cer
./hostLib/embSeEngine/a71chDemo/ecc/tls_client_key.pem
./hostLib/embSeEngine/a71chDemo/ecc/tls_rootca.cer
./hostLib/embSeEngine/a71chDemo/ecc/tls_rootca_key.pem
./hostLib/embSeEngine/a71chDemo/ecc/tls_server.cer
./hostLib/embSeEngine/a71chDemo/ecc/tls_server_key.pem
./hostLib/embSeEngine/a71chDemo/eccRef/
./hostLib/embSeEngine/a71chDemo/eccRef/ecc_key_kp_0_ref.pem
...
./hostLib/embSeEngine/a71chDemo/eccRef/ecc_key_pub_3_ref.pem
./hostLib/embSeEngine/a71chDemo/eccRef/Readme.txt
./hostLib/embSeEngine/a71chDemo/eccRef/tls_client_key_ref.pem
./hostLib/embSeEngine/a71chDemo/scripts/
./hostLib/embSeEngine/a71chDemo/scripts/a71chConfigCmdHistory.txt
./hostLib/embSeEngine/a71chDemo/scripts/a71chEccCsrDemo.sh
./hostLib/embSeEngine/a71chDemo/scripts/a71chEccSignDemo.sh
./hostLib/embSeEngine/a71chDemo/scripts/a71chEccSignNegTest.sh
./hostLib/embSeEngine/a71chDemo/scripts/a71chEcDhKa.sh
./hostLib/embSeEngine/a71chDemo/scripts/a71chPrepareEcc.sh
./hostLib/embSeEngine/a71chDemo/scripts/a71chRandDemo.sh
./hostLib/embSeEngine/a71chDemo/scripts/a71chTlsClient.sh
./hostLib/embSeEngine/a71chDemo/scripts/tlsCreateCredentialsRunOnClientOnce.sh
./hostLib/embSeEngine/a71chDemo/scripts/tlsPrepareClient.sh
./hostLib/embSeEngine/a71chDemo/scripts/tlsSeClient.sh
./hostLib/embSeEngine/a71chDemo/scripts/tlsServer.sh
./hostLib/embSeEngine/a71chEx/a71chEcDhKa
./hostLib/embSeEngine/a71chEx/a71chEcDhKa.c
./hostLib/embSeEngine/a71chEx/a71chEcDhKa.o
./hostLib/embSeEngine/a71chEx/a71chTlsClient
./hostLib/embSeEngine/a71chEx/a71chTlsClient.c
./hostLib/embSeEngine/a71chEx/a71chTlsClient.o
./hostLib/embSeEngine/a71chEx/Makefile_a71chEcDhKa
./hostLib/embSeEngine/a71chEx/Makefile_a71chTlsClient
./hostLib/embSeEngine/info/opensslA71CH_i2c.cnf
./linux/a71chConfig_i2c_imx
</pre><p>Create a symbolic link to the OpenSSL config file that configures OpenSSL for usage with the A71CH OpenSSL Engine </p><pre class="fragment">&gt;&gt; mkdir -p /etc/ssl   # Create directory '/etc/ssl' in case it does not yet exist
&gt;&gt; ln -s /home/root/axHostSw/hostLib/embSeEngine/info/opensslA71CH_i2c.cnf /etc/ssl/opensslA71CH_i2c.cnf
</pre><p>Create symbolic links to the A71CH shared library and OpenSSL engine (shared library) </p><pre class="fragment">&gt;&gt; ln -s /home/root/axHostSw/linux/libe2a71chi2c.so.1.0.0 /usr/lib/libe2a71chi2c.so
</pre><p>Ensure the location of the shared libraries libA71CH_i2c.so and libHLSE_A71CH_i2c.so is known by running the following command once </p><pre class="fragment">&gt;&gt; ldconfig /usr/local/lib
</pre><h1><a class="anchor" id="autotoc_md12"></a>
(5) Sanity check</h1>
<p>To verify whether the OpenSSL engine was properly installed on the embedded platform go into directory <code>/home/root/axHostSw/hostLib/embSeEngine/a71chDemo/scripts</code> and execute script <code>a71chRandDemo.sh</code>. This script will use the attached A71CH via the OpenSSL engine to generate random data. </p><pre class="fragment">&gt;&gt; cd /home/root/axHostSw/hostLib/embSeEngine/a71chDemo/scripts
&gt;&gt; ./a71chRandDemo.sh
A71CH Request Random Data demo script (Rev.0.8)
Configure OpenSSL to use A71CH
&gt;&gt; Request 40 byte from A71CH via OpenSSL
&gt;&gt; openssl rand -hex 40
Connect to A71CH. Chunksize at link layer = 256.
I2CInit: opening /dev/i2c-1
I2C driver: PEC flag cleared
I2C driver supports plain i2c-level commands.
I2C driver supports Read Block.
SCI2C_ATR=0xB8.04.11.01.05.04.B9.02.01.01.BA.01.01.BB.0D.41.37.31.30.31.43.48.20.32.34.32.52.31.BC.00.
HostLib Version  : 0x0110
Applet Version   : 0x0111
SecureBox Version: 0x0000
==========SELECT-DONE=========
e2a71ch-flw: Version: 1.0.0
e2a71ch-flw: EmbSe_Rand invoked requesting 40 random bytes
3c4b29b100c5174352cb630a925326db27be88e3cca53dbf430d1e5fc00ab26fc812206a8930eb7d
e2a71ch-flw: EmbSe_Rand invoked requesting 1024 random bytes
I2C0Term: not implemented.
e2a71ch-flw: EmbSe_Finish(): Entry
e2a71ch-flw: EmbSe_Destroy(): Entry

&gt;&gt; Request 400 byte from A71CH via OpenSSL
&gt;&gt; openssl rand -hex 400
Connect to A71CH. Chunksize at link layer = 256.
I2CInit: opening /dev/i2c-1
I2C driver: PEC flag cleared
....
....
** Demo completed successfully **
</pre><dl class="section note"><dt>Note</dt><dd>In case the SCP03 channel had already been setup on the A71CH sample, the ./a71chRandDemo.sh script will fail to execute successfully. In case you're using an A71CH sample in Debug mode, issue a debug reset with the config tool to bring the A71CH in its initial state and try again. <pre class="fragment">&gt;&gt; # [Optional 'Debug reset of A71CH' Step]
&gt;&gt; cd /home/root/axHostSw/linux
&gt;&gt; ./a71chConfig_i2c_imx debug reset
&gt;&gt; # [End-of Optional Step]
</pre></dd></dl>
<h1><a class="anchor" id="autotoc_md13"></a>
(6) Where to go from here ...</h1>
<p>Executing the different OpenSSL based examples is further documented in</p>
<ul>
<li><a class="el" href="page_a71ch_opensslengine_other_examples.html">OpenSSL Engine: Miscelaneous example</a></li>
<li><a class="el" href="page_a71ch_opensslengine_tls.html">OpenSSL Engine: TLS example</a> </li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="gax_openssl_engine.html">OpenSSL Engine</a></li>
    <li class="footer">Generated on Fri Sep 7 2018 19:24:07 for A71CH Host Sw by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
