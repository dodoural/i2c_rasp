<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>A71CH Host Sw: mbed TLS Integraton</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">A71CH Host Sw
   &#160;<span id="projectnumber">v01.05.00</span>
   </div>
   <div id="projectbrief">NXP Semiconductors</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('page_mbed_t_l_s.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">mbed TLS Integraton </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="mbedTLS_alt"></a>
ALT Implementation</h1>
<p>The A71CH is integrated with mbed TLS</p>
<h2><a class="anchor" id="mbedTLS_alt_Introduction"></a>
Introduction</h2>
<p>This document describes the integration and usage of mbed TLS on Kinetis Platform. It covers the usage scenarios and guidance to enable existing applications and usescases running on Kinetis Platform to use A71CHâ€™s for crypto functionality. As the A71CH only supports the EC-NIST-256 curve, this integration would allow applications to use ECC functionality from the A71CH. For the scope of this document, it is assumed that the reader is already aware of A71CH, A71CH Host Library, Kinetis, MCUXPresso. This document does not cover individual examples but gives a general overview/brief of integration.</p>
<h2><a class="anchor" id="mbedTLS_alt_mbedTLS"></a>
mbedTLS</h2>
<p>mbed TLS can be used to include cryptographic and SSL/TLS capabilities in embedded products, facilitating this functionality with minimal coding footprint. (For more details on mbed TLS please see <a href="https://tls.mbed.org/">https://tls.mbed.org/</a> )</p>
<h3><a class="anchor" id="mbedTLS_alt_config_header_file"></a>
mbedTLS configuration header file</h3>
<p>mbedTLS allows us to keep the custom configuration file for application outside the mbed TLS source tree. This can be easily achieved by defining the macro MBEDTLS_CONFIG_FILE to the desired filename (including the quote or angular brackets) at compile time. For example, using compiler directives like &lsquo;-Ipath/to/config -DMBEDTLS_CONFIG_FILE=&rsquo;&lt;my_config.h&gt;'"` See <a href="https://tls.mbed.org/kb/compiling-and-building/how-do-i-configure-mbedtls">https://tls.mbed.org/kb/compiling-and-building/how-do-i-configure-mbedtls</a> for more information.</p>
<h3><a class="anchor" id="mbedTLS_alt_macros"></a>
MBEDTLS_*_ALT Macros</h3>
<p>Most modules that implement cryptographic primitives, can be substituted with alternative implementations of the primitives to allow platforms to take advantage of the hardware acceleration or secure element that may be present. This can be achieved by defining in the appropriate MBEDTLS_*_ALT pre-processor symbol for each module that needs to be replaced. For example MBEDTLS_AES_ALT may be defined to replace the whole AES API with a hardware accelerated AES driver, and MBEDTLS_AES_ENCRYPT_ALT may be defined for replacing only the AES block encrypt functionality.</p>
<p>These _ALT macros can be enabled in the mbedTLS config file to make use of the hardware acceleration or secure element that may be present. For more details see <a href="https://tls.mbed.org/kb/how-to/how-do-i-port-mbed-tls-to-a-new-environment-OS">https://tls.mbed.org/kb/how-to/how-do-i-port-mbed-tls-to-a-new-environment-OS</a></p>
<h3><a class="anchor" id="mbedTLS_alt_ksdk"></a>
Kinetis/Freedom/KSDK alt implementation</h3>
<p>For applicable Kinetis series of MCUs, mbed TLS is already configured by above mechanisms to use implementation from within the KSDK. When a reference Kinetis project enabled for mbed TLS is imported from Kinetis SDK, it is can be seen that these extra files are also imported (apart from default files provided with mbed TLS):</p>
<ul>
<li><code>&lt;install_dir&gt;/ext/mbedTLS/port/ksdk/des_alt.c</code></li>
<li><code>&lt;install_dir&gt;/ext/mbedTLS/port/ksdk/des_alt.h</code></li>
<li><code>&lt;install_dir&gt;/ext/mbedTLS/port/ksdk/ksdk_mbedtls.c</code></li>
<li><code>&lt;install_dir&gt;/ext/mbedTLS/port/ksdk/ksdk_mbedtls.h</code></li>
<li><code>&lt;install_dir&gt;/ext/mbedTLS/port/ksdk/ksdk_mbedtls_config.h</code></li>
<li><code>&lt;install_dir&gt;/ext/mbedTLS/port/ksdk/sha1_alt.h</code></li>
<li><code>&lt;install_dir&gt;/ext/mbedTLS/port/ksdk/sha256_alt.h</code></li>
</ul>
<p>By default, <code>ksdk_mbedtls_config.h</code> is set as the <code>MBEDTLS_CONFIG_FILE</code> on the Kinetis platform.</p>
<h3><a class="anchor" id="mbedTLS_alt_a71ch"></a>
A71CH ALT implementation</h3>
<p>For an A71CH Enabled project, following files enable integration of mbed TLS with A71CH Table 1. mbed TLS integration ALT files</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">File  </th><th class="markdownTableHeadNone">Purpose   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">a71ch_mbedtls_frdm_config.h  </td><td class="markdownTableBodyNone">Like ksdk_mbedtls_config.h, but keeping it separate for isolation.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone"><a class="el" href="ecp__alt_8h.html" title="Elliptic curves over GF(p) ">ecp_alt.h</a>  </td><td class="markdownTableBodyNone">ALT Implementation for ECP   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a class="el" href="ecdh__alt_8c_source.html">ecdh_alt.c</a>  </td><td class="markdownTableBodyNone" rowspan="3">Implementation in these file is kept same as that in original implementation by mbed TLS. Implementation that interacts with A71CH is kept in *_alt_ax.c files.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone"><a class="el" href="ecp__alt_8c_source.html">ecp_alt.c</a>   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a class="el" href="ecp__curves__alt_8c_source.html">ecp_curves_alt.c</a>   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone"><a class="el" href="ax__mbedtls_8h.html">ax_mbedtls.h</a>  </td><td class="markdownTableBodyNone" rowspan="2">Logic for key association.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a class="el" href="ax__mbedtls_8c.html">ax_mbedtls.c</a>   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone"><a class="el" href="ecdh__alt__ax_8c.html">ecdh_alt_ax.c</a>  </td><td class="markdownTableBodyNone" rowspan="2">ALT implementation that interacts with A71CH   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a class="el" href="ecp__alt__ax_8c.html">ecp_alt_ax.c</a>   </td></tr>
</table>
<h3><a class="anchor" id="mbedTLS_alt_extensions"></a>
Extensions on top of KSDKâ€™s mbed TLS modifications</h3>
<p>The mbed TLS provided with KSDK is not same as the version available from <a href="https://tls.mbed.org/download">https://tls.mbed.org/download</a> Few files are modified for porting on Kinetis platform. On similar lines, default mbed TLS does not allow alternate implementations of EDCH/ECDSA. To support ALT implementation of ECDH/ECDSA, part of mbed TLS code is also modified. mbedtls/library/ecdh.c is modified to support alt implementation. The default implementation from mbed TLS cannot have ALT implementation out of the box.</p>
<h2><a class="anchor" id="mbedtls_alt_key_usage"></a>
Key usage</h2>
<h3><a class="anchor" id="mbedtls_alt_gen_load_key"></a>
Generating/Loading Keys vs referencing by index</h3>
<p>Although mbedTLS supports generation/loading of the keys required for cryptographic operations such as signing and verification. In the interest of security, it is obvious to store these keys inside the secure element and not take them out to the host micro controller. Also, keys are provisioned in prior stages rather than during execution of default application. For cryptographic operations eventually we use only indexes to these keys within the A71CH. For OpenSSL engine integration with mbed TLS, specifically formatted Private Keys are used (see [um433410]). However, for embedded platforms, this would not be the right alternative to save memory and avoid processing power during parsing of such keys. As an alternative, the keys are referenced by indexes.</p>
<h3><a class="anchor" id="type_ax_index"></a>
mbedtls_ecp_group::type_ax_index</h3>
<p>As part of ALT implementation of ECC, a member type_ax_index is added to the <a class="el" href="structmbedtls__ecp__group.html" title="ECP group structure. ">mbedtls_ecp_group</a> structure to refer to the key with that index. By default, if the keys are to be loaded/used directly from the host microcontroller, type_ax_index is set to 0 by default and the implementation remains backward compatible without using A71CH. Where applicable, the ALT implementation refers to this index to use cryptographic operations from A71CH using those indexes.</p>
<h3><a class="anchor" id="asso_key"></a>
Associating keys</h3>
<p>The set of APIs for associating keys with relevant context is exposed in <a class="el" href="ax__mbedtls_8h.html">ax_mbedtls.h</a> file.</p>
<h3><a class="anchor" id="pub_key"></a>
Public Keys</h3>
<p>For cases when we want to use A71CH to use itâ€™s public keys, API to be used is <a class="el" href="ax__mbedtls_8h.html#ae8f461efc0ce2051b80c77530c15b73c">ax_mbedtls_associate_pubkey</a> (e.g. signature verification). For embedded application, this API call is akin to mbedtls_pk_parse_key and similar family of APIs.</p>
<h3><a class="anchor" id="priv_key"></a>
Private Keys</h3>
<p>For cases when we want to use A71CH to use itâ€™s private keys (e.g. signing). APIs are listed in <a class="el" href="ax__mbedtls_8h.html#ae8f461efc0ce2051b80c77530c15b73c">ax_mbedtls_associate_pubkey</a>. For embedded application, this API call is akin to mbedtls_pk_parse_key and similar family of APIs.</p>
<h3><a class="anchor" id="tls_ecdh_handshake"></a>
TLS ECDH handshake</h3>
<p>During TLS handhake, after setup of ssl context (API call to mbedtls_ssl_setup) use has to call <a class="el" href="ax__mbedtls_8h.html#aff04ced3022a229619ab0fd2414dbfe5">ax_mbedtls_associate_ecdhctx</a> to associate private key to be used during exchange. This would enable the usage of the private key of A71CH to compute shared secret.</p>
<h3><a class="anchor" id="existing_middleware"></a>
Existing middleware/wrappers</h3>
<p>Some existing middleware written on top of mbed TLS already expect user to create global constants with keys to be used during TLS Negotiation, or full keys (either in PEM or DER Format) are passed to mbed TLS. For such middleware, the approach for enable for A71CH can be to use key length of 1.</p>
<p>e.g. for <code>middleware\aws_iot\platform\lwip\network_mbedtls_wrapper.c</code></p>
<p>Usage by Middleware (<code>network_mbedtls_wrapper.c</code>):</p>
<div class="fragment"><div class="line"><span class="comment">/* Private key */</span></div><div class="line"><span class="keyword">extern</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> privKey[];</div><div class="line"><span class="keyword">extern</span> <span class="keyword">const</span> <span class="keywordtype">size_t</span> lenPrivKey;</div></div><!-- fragment --><p>Middleware now expects privKey and lenPrivKey to be set by application: Application can do as below .</p>
<div class="fragment"><div class="line"><span class="comment">/* Private key */</span></div><div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> privKey[] = {AWS_IOT_KEYS_INDEX_SM};</div><div class="line"><span class="keyword">const</span> <span class="keywordtype">size_t</span> lenPrivKey = <span class="keyword">sizeof</span>(privKey);</div></div><!-- fragment --><p>Now, the middleware can take hint that lenPrivate key is only 1 and hence this must be associated/used from the A71CH.</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (lenPrivKey == 1) {</div><div class="line">    <a class="code" href="ax__mbedtls_8c.html#aff04ced3022a229619ab0fd2414dbfe5">ax_mbedtls_associate_ecdhctx</a>(</div><div class="line">        privKey[0], tlsDataParams-&gt;ssl.handshake );</div><div class="line">}</div></div><!-- fragment --><p>The above approach can be extrapolated for other such middleware as well.</p>
<h2><a class="anchor" id="cert"></a>
Certificates</h2>
<p>Just as described in case of associating keys from the A71CH, the GP storage inside the A71CH can also be used to store/use certificates.</p>
<p>e.g. for <code>middleware\aws_iot\platform\lwip\network_mbedtls_wrapper.c</code></p>
<p>Usage by Middleware (network_mbedtls_wrapper.c):</p>
<div class="fragment"><div class="line"><span class="comment">/* Device certificate */</span></div><div class="line"><span class="keyword">extern</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> certClient[];</div><div class="line"><span class="keyword">extern</span> <span class="keyword">const</span> <span class="keywordtype">size_t</span> lenCertClient;</div></div><!-- fragment --><p>Middleware now expects privKey and lenPrivKey to be set by application: Application can do as below.</p>
<div class="fragment"><div class="line"><span class="comment">/* Device certificate */</span></div><div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> certClient[] = {</div><div class="line">    0x00,0x00,</div><div class="line">    <span class="comment">// Starting address in GP Storage.</span></div><div class="line">    <span class="comment">// (Little Endian Format)</span></div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">const</span> <span class="keywordtype">size_t</span> lenCertClient = <span class="keyword">sizeof</span>(certClient);</div></div><!-- fragment --><p>Now, the middleware can take hint that lenPrivate key is only 1 and hence this must be associated/used from the A71CH.</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (lenCertClient == 2) {</div><div class="line">    <span class="comment">// Possibly certificate is in GP Storage</span></div><div class="line">    SM_Error_t ret_code;</div><div class="line">    uint16_t start_addr;</div><div class="line">    uint16_t crt_len;</div><div class="line">    <span class="comment">// Assuming 500 bytes maximum for certificate</span></div><div class="line">    uint8_t aclient_cer[500];</div><div class="line">    uint8_t certPattern[] = {0x30, 0x82};</div><div class="line"></div><div class="line">    <span class="comment">// Calculate address of that certificate</span></div><div class="line">    start_addr = certClient[1];</div><div class="line">    start_addr = start_addr &lt;&lt; 8;</div><div class="line">    start_addr |= certClient[0];</div><div class="line"></div><div class="line">    <span class="comment">// Read 1st 4 bytes to vaguely detect if it&#39;s valid</span></div><div class="line">    <span class="comment">// certificate and it&#39;s length</span></div><div class="line">    ret_code = <a class="code" href="a71ch__api_8h.html#adaf5118bb67678076510abe8fbea0dda">A71_GetGpData</a>(start_addr, aclient_cer, 4);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> ((aclient_cer[0] == certPattern[0])</div><div class="line">        &amp;&amp; (aclient_cer[1] == certPattern[1]))</div><div class="line">    {</div><div class="line">        <span class="comment">/* OK */</span></div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">        printf(<span class="stringliteral">&quot;No certificate found on offset 0x%04X.\r\n&quot;</span>, start_addr);</div><div class="line">        <span class="keywordflow">return</span> FAILURE;</div><div class="line">    }</div><div class="line"></div><div class="line">    crt_len = 4 + (aclient_cer[2] &lt;&lt; 8) + aclient_cer[3];</div><div class="line">    <span class="keywordflow">if</span> (crt_len &gt; <span class="keyword">sizeof</span>(aclient_cer)) {</div><div class="line">        <span class="comment">// Provided buffer is too small to contain certificate</span></div><div class="line">        printf( <span class="stringliteral">&quot;Provided certificate buffer too small: Provided=%d &lt;&gt; Required=%d.\r\n&quot;</span>,<span class="keyword">sizeof</span>(aclient_cer), crt_len);</div><div class="line">        <span class="keywordflow">return</span> FAILURE;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">// Read certificate from GP Storage</span></div><div class="line">    ret_code = <a class="code" href="a71ch__api_8h.html#adaf5118bb67678076510abe8fbea0dda">A71_GetGpData</a>(start_addr, aclient_cer, crt_len);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span>(<a class="code" href="sm__types_8h.html#a8c7b7be5dd3dcbaa85f9d9536fc93f55">SW_OK</a> != ret_code)</div><div class="line">    {</div><div class="line">        IOT_ERROR(<span class="stringliteral">&quot; failed\n  ! GP read failed\n\r\n&quot;</span>);</div><div class="line">    }</div><div class="line">    ret = mbedtls_x509_crt_parse_der(&amp;(tlsDataParams-&gt;clicert), aclient_cer, crt_len);</div><div class="line">    <span class="comment">//...</span></div><div class="line">    <span class="comment">//...</span></div></div><!-- fragment --><p>The above approach can be extrapolated for other such middleware as well. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Fri Sep 7 2018 19:24:07 for A71CH Host Sw by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
