<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>A71CH Host Sw: C:/ubuntu_exchange/axHostSw/hostLib/a71ch/src/a71ch_crypto_derive.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">A71CH Host Sw
   &#160;<span id="projectnumber">v01.05.00</span>
   </div>
   <div id="projectbrief">NXP Semiconductors</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('a71ch__crypto__derive_8c.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">a71ch_crypto_derive.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &lt;stddef.h&gt;</code><br />
<code>#include &lt;assert.h&gt;</code><br />
<code>#include &lt;string.h&gt;</code><br />
<code>#include &lt;stdio.h&gt;</code><br />
<code>#include &quot;<a class="el" href="scp_8h_source.html">scp.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="a71ch__api_8h_source.html">a71ch_api.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="sm__apdu_8h_source.html">sm_apdu.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="sm__errors_8h_source.html">sm_errors.h</a>&quot;</code><br />
</div>
<p><a href="a71ch__crypto__derive_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a05af19cd521c37f82b293381e94bc77e"><td class="memItemLeft" align="right" valign="top">U16&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a71ch__crypto__derive_8c.html#a05af19cd521c37f82b293381e94bc77e">A71_HkdfExpandSymKey</a> (SST_Index_t index, U8 nBlock, const U8 *info, U16 infoLen, U8 *derivedData, U16 derivedDataLen)</td></tr>
<tr class="separator:a05af19cd521c37f82b293381e94bc77e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8c00c91c1bbe064ac4ccdb8c61d6d41b"><td class="memItemLeft" align="right" valign="top">U16&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a71ch__crypto__derive_8c.html#a8c00c91c1bbe064ac4ccdb8c61d6d41b">A71_HkdfSymKey</a> (SST_Index_t index, U8 nBlock, const U8 *salt, U16 saltLen, const U8 *info, U16 infoLen, U8 *derivedData, U16 derivedDataLen)</td></tr>
<tr class="separator:a8c00c91c1bbe064ac4ccdb8c61d6d41b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab217a564829034e240abe4da32d1eb4e"><td class="memItemLeft" align="right" valign="top">U16&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a71ch__crypto__derive_8c.html#ab217a564829034e240abe4da32d1eb4e">A71_PskDeriveMasterSecret</a> (SST_Index_t index, U8 nBlock, const U8 *serverHelloRnd, U16 serverHelloRndLen, U8 *masterSecret)</td></tr>
<tr class="separator:ab217a564829034e240abe4da32d1eb4e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1c6754f6ead68081bc7d51c80e17f159"><td class="memItemLeft" align="right" valign="top">U16&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a71ch__crypto__derive_8c.html#a1c6754f6ead68081bc7d51c80e17f159">A71_EcdhPskDeriveMasterSecret</a> (SST_Index_t indexKp, const U8 *publicKey, U16 publicKeyLen, SST_Index_t index, U8 nBlock, const U8 *serverHelloRnd, U16 serverHelloRndLen, U8 *masterSecret)</td></tr>
<tr class="separator:a1c6754f6ead68081bc7d51c80e17f159"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acabbe8587005e7f511d6f3c75a09736e"><td class="memItemLeft" align="right" valign="top">U16&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a71ch__crypto__derive_8c.html#acabbe8587005e7f511d6f3c75a09736e">A71_GetHmacSha256</a> (SST_Index_t index, U8 nBlock, const U8 *data, U16 dataLen, U8 *hmac, U16 *hmacLen)</td></tr>
<tr class="separator:acabbe8587005e7f511d6f3c75a09736e"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><dl class="section author"><dt>Author</dt><dd>NXP Semiconductors </dd></dl>
<dl class="section version"><dt>Version</dt><dd>1.0 </dd></dl>
<dl class="section user"><dt>License</dt><dd>Copyright 2016 NXP</dd></dl>
<p>This software is owned or controlled by NXP and may only be used strictly in accordance with the applicable license terms. By expressly accepting such terms or by downloading, installing, activating and/or otherwise using the software, you are agreeing that you have read, and that you agree to comply with and are bound by, such license terms. If you do not agree to be bound by the applicable license terms, then you may not retain, install, activate or otherwise use the software.</p>
<dl class="section user"><dt>Description</dt><dd>This file wraps the key derivation functionality of the A71CH module. </dd></dl>
<dl class="section user"><dt>History</dt><dd>1.0 2016-Sep-22 : Initial version </dd></dl>

<p class="definition">Definition in file <a class="el" href="a71ch__crypto__derive_8c_source.html">a71ch_crypto_derive.c</a>.</p>
</div><h2 class="groupheader">Function Documentation</h2>
<a id="a1c6754f6ead68081bc7d51c80e17f159"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1c6754f6ead68081bc7d51c80e17f159">&#9670;&nbsp;</a></span>A71_EcdhPskDeriveMasterSecret()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">U16 A71_EcdhPskDeriveMasterSecret </td>
          <td>(</td>
          <td class="paramtype">SST_Index_t&#160;</td>
          <td class="paramname"><em>indexKp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const U8 *&#160;</td>
          <td class="paramname"><em>publicKey</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">U16&#160;</td>
          <td class="paramname"><em>publicKeyLen</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">SST_Index_t&#160;</td>
          <td class="paramname"><em>index</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">U8&#160;</td>
          <td class="paramname"><em>nBlock</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const U8 *&#160;</td>
          <td class="paramname"><em>serverHelloRnd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">U16&#160;</td>
          <td class="paramname"><em>serverHelloRndLen</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">U8 *&#160;</td>
          <td class="paramname"><em>masterSecret</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>This function calculates the PRF according to TLS1.2 [RFC5246]. The pre-master secret is formed - based upon a pre-shared secret (PSK) stored in the secure module and on an ECDH calculation - according to [RFC5489].</p>
<p>The pre-shared secret is stored in the SYM key store. It can be either 16, 32, 48 or 64 byte long. The Most Significant part of the pre-shared secret resides in the storage location with the lowest index. The subsequent parts reside in the next storage locations. The nBlock parameter is equal to the length of the PSK divided by 16.</p>
<p>A PSK cannot be stored wrapped around in the SYM key store.</p>
<p>The PRF creating the masterSecret also takes as parameter the concatentation of label ("master_secret"), ClientHello.random and ServerHello.random. This function only takes ServerHello.random as parameter: ClientHello.random has already been set by a call to <a class="el" href="a71ch__module_8c.html#a41482fb30f0889dda031ca304347b36a">A71_CreateClientHelloRandom</a>, the value of the label (default is "master_secret") can be overruled by a call to <a class="el" href="a71ch__module_8c.html#a613ce459466d0fbd6b46ee2324875b9c">A71_SetTlsLabel</a>.</p>
<dl class="section pre"><dt>Precondition</dt><dd>This call must be preceded by a call to <a class="el" href="a71ch__module_8c.html#a41482fb30f0889dda031ca304347b36a">A71_CreateClientHelloRandom</a>, no other A71CH API call (implying an APDU exchange between Host and A71CH) may be executed in between the invocation of <a class="el" href="a71ch__module_8c.html#a41482fb30f0889dda031ca304347b36a">A71_CreateClientHelloRandom</a> and <a class="el" href="a71ch__crypto__derive_8c.html#a1c6754f6ead68081bc7d51c80e17f159">A71_EcdhPskDeriveMasterSecret</a></dd></dl>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">indexKp</td><td>Index of the ECC keypair whose private key is used in the ECDH operation </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">publicKey</td><td>Value of the public key to be used in ECDH operation </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">publicKeyLen</td><td>Length of publicKey in byte </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">index</td><td>Index of the SYM key store containing the MSB part of the pre-shared secret </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">nBlock</td><td>Amount of blocks, equivalent to the pre-shared secret length when multiplied by 16 </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">serverHelloRnd</td><td>ServerHello.random (concatenated with values already contained in A71CH) </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">serverHelloRndLen</td><td>The length of serverHelloRnd passed as an argument </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">masterSecret</td><td>IN: caller passes a buffer of at least 48 byte; OUT: contains the calculated master Secret, TLS 1.2 mandates this to be 48 byte exact</td></tr>
  </table>
  </dd>
</dl>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname"><a class="el" href="sm__types_8h.html#a8c7b7be5dd3dcbaa85f9d9536fc93f55" title="Operation successfull. ">SW_OK</a></td><td>Successfull execution </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="a71ch__crypto__derive_8c_source.html#l00270">270</a> of file <a class="el" href="a71ch__crypto__derive_8c_source.html">a71ch_crypto_derive.c</a>.</p>

</div>
</div>
<a id="acabbe8587005e7f511d6f3c75a09736e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#acabbe8587005e7f511d6f3c75a09736e">&#9670;&nbsp;</a></span>A71_GetHmacSha256()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">U16 A71_GetHmacSha256 </td>
          <td>(</td>
          <td class="paramtype">SST_Index_t&#160;</td>
          <td class="paramname"><em>index</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">U8&#160;</td>
          <td class="paramname"><em>nBlock</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const U8 *&#160;</td>
          <td class="paramname"><em>data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">U16&#160;</td>
          <td class="paramname"><em>dataLen</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">U8 *&#160;</td>
          <td class="paramname"><em>hmac</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">U16 *&#160;</td>
          <td class="paramname"><em>hmacLen</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Calculates the HMAC on <code>data</code> using SHA256 as Hash Function according to [RFC2104]. The secret is stored in the SYM key store. It can be either 16, 32, 48 or 64 byte long. The Most Significant part of the secret resides in the storage location with the lowest index. The subsequent parts reside in the next storage locations. The nBlock parameter is equal to the length of the secret divided by 16. A secret with length 64 can only start at Index 0 of the SYM key store: a secret can not be stored wrapped around in the SYM key store. </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">index</td><td>Index of the SYM key store containing the MSB part of the pre-shared secret </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">nBlock</td><td>Amount of blocks, equivalent to the pre-shared secret length when multiplied by 16 </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">data</td><td>Data buffer for which the HMAC-SHA256 must be calculated </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dataLen</td><td>The length of data passed as argument </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">hmac</td><td>IN: caller passes a buffer of at least 32 byte; OUT: contains the calculated hmac </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">hmacLen</td><td>IN: length of the hmac buffer passed; OUT: because SHA256 is used this is 32 byte exact</td></tr>
  </table>
  </dd>
</dl>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname"><a class="el" href="sm__types_8h.html#a8c7b7be5dd3dcbaa85f9d9536fc93f55" title="Operation successfull. ">SW_OK</a></td><td>Successfull execution </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="a71ch__crypto__derive_8c_source.html#l00343">343</a> of file <a class="el" href="a71ch__crypto__derive_8c_source.html">a71ch_crypto_derive.c</a>.</p>

</div>
</div>
<a id="a05af19cd521c37f82b293381e94bc77e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a05af19cd521c37f82b293381e94bc77e">&#9670;&nbsp;</a></span>A71_HkdfExpandSymKey()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">U16 A71_HkdfExpandSymKey </td>
          <td>(</td>
          <td class="paramtype">SST_Index_t&#160;</td>
          <td class="paramname"><em>index</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">U8&#160;</td>
          <td class="paramname"><em>nBlock</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const U8 *&#160;</td>
          <td class="paramname"><em>info</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">U16&#160;</td>
          <td class="paramname"><em>infoLen</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">U8 *&#160;</td>
          <td class="paramname"><em>derivedData</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">U16&#160;</td>
          <td class="paramname"><em>derivedDataLen</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>The HMAC Key Derivation function derives a key from a stored secret using SHA256 as hash function according to [RFC5869]. Only the expand step will be executed.</p>
<p>The secret is stored in the SYM key store. It can be either 16, 32, 48 or 64 byte long. The Most Significant part of the secret resides in the storage location with the lowest index. The subsequent parts reside in the next storage locations. The nBlock parameter is equal to the length of the secret divided by 16. A secret with length 64 can only start at Index 0 of the SYM key store: a secret can not be stored wrapped around in the SYM key store.</p>
<dl class="section note"><dt>Note</dt><dd>infoLen must be smaller than 254 byte.</dd></dl>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">index</td><td>Index of the SYM key store containing the MSB part of the pre-shared secret </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">nBlock</td><td>Amount of blocks, equivalent to the pre-shared secret length when multiplied by 16 </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">info</td><td>Context and application specific information used in expand step </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">infoLen</td><td>The length of the info data passed as argument </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">derivedData</td><td>IN: caller passes a buffer of at least derivedDataLen; OUT: contains the calculated derived data </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">derivedDataLen</td><td>IN: length of the requested derivedData. Must be smaller than 256 byte.</td></tr>
  </table>
  </dd>
</dl>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname"><a class="el" href="sm__types_8h.html#a8c7b7be5dd3dcbaa85f9d9536fc93f55" title="Operation successfull. ">SW_OK</a></td><td>Successfull execution </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="a71ch__crypto__derive_8c_source.html#l00118">118</a> of file <a class="el" href="a71ch__crypto__derive_8c_source.html">a71ch_crypto_derive.c</a>.</p>

</div>
</div>
<a id="a8c00c91c1bbe064ac4ccdb8c61d6d41b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8c00c91c1bbe064ac4ccdb8c61d6d41b">&#9670;&nbsp;</a></span>A71_HkdfSymKey()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">U16 A71_HkdfSymKey </td>
          <td>(</td>
          <td class="paramtype">SST_Index_t&#160;</td>
          <td class="paramname"><em>index</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">U8&#160;</td>
          <td class="paramname"><em>nBlock</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const U8 *&#160;</td>
          <td class="paramname"><em>salt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">U16&#160;</td>
          <td class="paramname"><em>saltLen</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const U8 *&#160;</td>
          <td class="paramname"><em>info</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">U16&#160;</td>
          <td class="paramname"><em>infoLen</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">U8 *&#160;</td>
          <td class="paramname"><em>derivedData</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">U16&#160;</td>
          <td class="paramname"><em>derivedDataLen</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>The HMAC Key Derivation function derives a key from a stored secret using SHA256 as hash function according to [RFC5869]. Both the extract and expand steps will be executed.</p>
<p>In case a zero length salt value is passed as argument, this function is equivalent to A71_HkdfExpandSymKey: i.e. the extract step is skipped. To enforce the usage of the default salt value (a Bytestring of 32 zeroes) the caller must explicitly pass this default salt value as argument to this function.</p>
<p>The secret is stored in the SYM key store. It can be either 16, 32, 48 or 64 byte long. The Most Significant part of the secret resides in the storage location with the lowest index. The subsequent parts reside in the next storage locations. The nBlock parameter is equal to the length of the secret divided by 16. A secret with length 64 can only start at Index 0 of the SYM key store: a secret can not be stored wrapped around in the SYM key store.</p>
<dl class="section note"><dt>Note</dt><dd>The sum of saltLen and infoLen must be smaller than 254 byte.</dd></dl>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">index</td><td>Index of the SYM key store containing the MSB part of the pre-shared secret </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">nBlock</td><td>Amount of blocks, equivalent to the pre-shared secret length when multiplied by 16 </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">salt</td><td>Salt data used in extract step </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">saltLen</td><td>The length of the salt data passed as argument </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">info</td><td>Context and application specific information used in expand step </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">infoLen</td><td>The length of the info data passed as argument </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">derivedData</td><td>IN: caller passes a buffer of at least derivedDataLen; OUT: contains the calculated derived data </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">derivedDataLen</td><td>IN: length of the requested derivedData. Must be smaller than 256 byte.</td></tr>
  </table>
  </dd>
</dl>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname"><a class="el" href="sm__types_8h.html#a8c7b7be5dd3dcbaa85f9d9536fc93f55" title="Operation successfull. ">SW_OK</a></td><td>Successfull execution </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="a71ch__crypto__derive_8c_source.html#l00154">154</a> of file <a class="el" href="a71ch__crypto__derive_8c_source.html">a71ch_crypto_derive.c</a>.</p>

</div>
</div>
<a id="ab217a564829034e240abe4da32d1eb4e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab217a564829034e240abe4da32d1eb4e">&#9670;&nbsp;</a></span>A71_PskDeriveMasterSecret()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">U16 A71_PskDeriveMasterSecret </td>
          <td>(</td>
          <td class="paramtype">SST_Index_t&#160;</td>
          <td class="paramname"><em>index</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">U8&#160;</td>
          <td class="paramname"><em>nBlock</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const U8 *&#160;</td>
          <td class="paramname"><em>serverHelloRnd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">U16&#160;</td>
          <td class="paramname"><em>serverHelloRndLen</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">U8 *&#160;</td>
          <td class="paramname"><em>masterSecret</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>This function calculates the PRF according to TLS1.2 [RFC5246]. The pre-master secret is formed - based upon a pre-shared secret (PSK) stored in the secure module - according to [RFC4279].</p>
<p>The pre-shared secret is stored in the SYM key store. It can be either 16, 32, 48 or 64 byte long. The Most Significant part of the pre-shared secret resides in the storage location with the lowest index. The subsequent parts reside in the next storage locations. The nBlock parameter is equal to the length of the PSK divided by 16.</p>
<p>A PSK cannot be stored wrapped around in the SYM key store.</p>
<p>The PRF creating the masterSecret also takes as parameter the concatentation of label ("master_secret"), ClientHello.random and ServerHello.random. This function only takes ServerHello.random as parameter: ClientHello.random has already been set by a call to <a class="el" href="a71ch__module_8c.html#a41482fb30f0889dda031ca304347b36a">A71_CreateClientHelloRandom</a>, the value of the label (default is "master_secret") can be overruled by a call to <a class="el" href="a71ch__module_8c.html#a613ce459466d0fbd6b46ee2324875b9c">A71_SetTlsLabel</a>.</p>
<dl class="section pre"><dt>Precondition</dt><dd>This call must be preceded by a call to <a class="el" href="a71ch__module_8c.html#a41482fb30f0889dda031ca304347b36a">A71_CreateClientHelloRandom</a>, no other A71CH API call (implying an APDU exchange between Host and A71CH) may be executed in between the invocation of <a class="el" href="a71ch__module_8c.html#a41482fb30f0889dda031ca304347b36a">A71_CreateClientHelloRandom</a> and <a class="el" href="a71ch__crypto__derive_8c.html#ab217a564829034e240abe4da32d1eb4e">A71_PskDeriveMasterSecret</a></dd></dl>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">index</td><td>Index of the SYM key store containing the MSB part of the pre-shared secret </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">nBlock</td><td>Amount of blocks, equivalent to the pre-shared secret length when multiplied by 16 </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">serverHelloRnd</td><td>ServerHello.random (concatenated with values already contained in A71CH) </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">serverHelloRndLen</td><td>The length of serverHelloRnd passed as an argument </td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">masterSecret</td><td>IN: caller passes a buffer of at least 48 byte; OUT: contains the calculated master Secret, TLS 1.2 mandates this to be 48 byte exact</td></tr>
  </table>
  </dd>
</dl>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname"><a class="el" href="sm__types_8h.html#a8c7b7be5dd3dcbaa85f9d9536fc93f55" title="Operation successfull. ">SW_OK</a></td><td>Successfull execution </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="a71ch__crypto__derive_8c_source.html#l00186">186</a> of file <a class="el" href="a71ch__crypto__derive_8c_source.html">a71ch_crypto_derive.c</a>.</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_334bf0e2cc3331174eefb01118a0a83d.html">hostLib</a></li><li class="navelem"><a class="el" href="dir_ceffb261bb5d756d1931d3d27f14ec57.html">a71ch</a></li><li class="navelem"><a class="el" href="dir_aea1d74edf7334533e1d37ace23cdbae.html">src</a></li><li class="navelem"><a class="el" href="a71ch__crypto__derive_8c.html">a71ch_crypto_derive.c</a></li>
    <li class="footer">Generated on Fri Sep 7 2018 19:24:07 for A71CH Host Sw by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
