<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>A71CH Host Sw: a71ch_dox/mbedtls_integration.md Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">A71CH Host Sw
   &#160;<span id="projectnumber">v01.05.00</span>
   </div>
   <div id="projectbrief">NXP Semiconductors</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('mbedtls__integration_8md.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">a71ch_dox/mbedtls_integration.md</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;# mbedTLS1 Integration {#page_mbedTLS}</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;# ALT Implementation {#mbedTLS_alt}</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;The A71CH is integrated with mbed TLS</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;## Introduction{#mbedTLS_alt_Introduction}</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;This document describes the integration and usage of mbed TLS on Kinetis Platform.</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;It covers the usage scenarios and guidance to enable existing applications and usescases running on Kinetis Platform to use A71CHâ€™s for crypto functionality.</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;As the A71CH only supports the EC-NIST-256 curve, this integration would allow applications to use ECC functionality from the A71CH.</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;For the scope of this document, it is assumed that the reader is already aware of A71CH, A71CH Host Library, Kinetis, MCUXPresso.</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;This document does not cover individual examples but gives a general overview/brief of integration.</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;## mbedTLS {#mbedTLS_alt_mbedTLS}</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;mbed TLS can be used to include cryptographic and SSL/TLS capabilities in embedded products,</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;facilitating this functionality with minimal coding footprint. (For more details on mbed TLS please see https://tls.mbed.org/ )</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;### mbedTLS configuration header file{#mbedTLS_alt_config_header_file}</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;mbedTLS allows us to keep the custom configuration file for application outside the mbed TLS source tree.</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;This can be easily achieved by defining the macro MBEDTLS_CONFIG_FILE to the desired filename</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;(including the quote or angular brackets) at compile time. For example, using compiler directives like</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;`-Ipath/to/config -DMBEDTLS_CONFIG_FILE=&#39;&lt;my_config.h&gt;&#39;&quot;`</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;See https://tls.mbed.org/kb/compiling-and-building/how-do-i-configure-mbedtls for more information.</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;### MBEDTLS_*_ALT Macros {#mbedTLS_alt_macros}</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;Most modules that implement cryptographic primitives, can be substituted with alternative implementations</div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;of the primitives to allow platforms to take advantage of the hardware acceleration</div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;or secure element that may be present. This can be achieved by defining in the appropriate</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;MBEDTLS_*_ALT pre-processor symbol for each module that needs to be replaced.</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;For example MBEDTLS_AES_ALT may be defined to replace the whole AES API with a hardware accelerated AES driver,</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;and MBEDTLS_AES_ENCRYPT_ALT may be defined for replacing only the AES block encrypt functionality.</div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;</div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;These _ALT macros can be enabled in the mbedTLS config file to make use of the hardware acceleration or secure element that may be present.</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;For more details see https://tls.mbed.org/kb/how-to/how-do-i-port-mbed-tls-to-a-new-environment-OS</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;### Kinetis/Freedom/KSDK alt implementation{#mbedTLS_alt_ksdk}</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;For applicable Kinetis series of MCUs, mbed TLS is already configured by above mechanisms to use implementation from within the KSDK.</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;When a reference Kinetis project enabled for mbed TLS is imported from Kinetis SDK, it is can be seen that these extra files are also imported</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;(apart from default files provided with mbed TLS):</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;  - ` &amp;lt;install_dir&amp;gt;/ext/mbedTLS/port/ksdk/des_alt.c`</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;  - ` &amp;lt;install_dir&amp;gt;/ext/mbedTLS/port/ksdk/des_alt.h`</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;  - ` &amp;lt;install_dir&amp;gt;/ext/mbedTLS/port/ksdk/ksdk_mbedtls.c`</div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;  - ` &amp;lt;install_dir&amp;gt;/ext/mbedTLS/port/ksdk/ksdk_mbedtls.h`</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;  - ` &amp;lt;install_dir&amp;gt;/ext/mbedTLS/port/ksdk/ksdk_mbedtls_config.h`</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;  - ` &amp;lt;install_dir&amp;gt;/ext/mbedTLS/port/ksdk/sha1_alt.h`</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;  - ` &amp;lt;install_dir&amp;gt;/ext/mbedTLS/port/ksdk/sha256_alt.h`</div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;</div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;By default, `ksdk_mbedtls_config.h` is set as the `MBEDTLS_CONFIG_FILE` on the Kinetis platform.</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;</div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;### A71CH ALT implementation{#mbedTLS_alt_a71ch}</div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;For an A71CH Enabled project, following files enable integration of mbed TLS with A71CH</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;Table 1.   mbed TLS integration ALT files</div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;| File                      |    Purpose |</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;|---------------------------|--------------------------------------------------|</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;a71ch_mbedtls_frdm_config.h    |  Like ksdk_mbedtls_config.h, but keeping it separate for isolation.</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;ecp_alt.h                   |  ALT Implementation for ECP</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;ecdh_alt.c                  |  Implementation in these file is kept same as that in original implementation by mbed TLS. Implementation that interacts with A71CH is kept in *_alt_ax.c files.</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;ecp_alt.c                   |  ^</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;ecp_curves_alt.c            |  ^</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;ax_mbedtls.h                |  Logic for key association.</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;ax_mbedtls.c                |  ^</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;ecdh_alt_ax.c               |  ALT implementation that interacts with A71CH</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;ecp_alt_ax.c                |  ^</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;### Extensions on top of KSDKâ€™s mbed TLS modifications {#mbedTLS_alt_extensions}</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;The mbed TLS provided with KSDK is not same as the version available from https://tls.mbed.org/download Few files are modified for porting on Kinetis platform. On similar lines, default mbed TLS does not allow alternate implementations of EDCH/ECDSA. To support ALT implementation of ECDH/ECDSA, part of mbed TLS code is also modified. mbedtls/library/ecdh.c is modified to support alt implementation. The default implementation from mbed TLS cannot have ALT implementation out of the box.</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;## Key usage {#mbedtls_alt_key_usage}</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;###  Generating/Loading Keys vs referencing by index {#mbedtls_alt_gen_load_key}</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;Although mbedTLS supports generation/loading of the keys required for cryptographic operations such as signing and verification. In the interest of security, it is obvious to store these keys inside the secure element and not take them out to the host micro controller.  Also, keys are provisioned in prior stages rather than during execution of default application. For cryptographic operations eventually we use only indexes to these keys within the A71CH.</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;For OpenSSL engine integration with mbed TLS, specifically formatted Private Keys are used (see [um433410]). However, for embedded platforms, this would not be the right alternative to save memory and avoid processing power during parsing of such keys. As an alternative, the keys are referenced by indexes.</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;###    mbedtls_ecp_group::type_ax_index {#type_ax_index}</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;As part of ALT implementation of ECC, a member type_ax_index is added to the mbedtls_ecp_group structure to refer to the key with that index. By default, if the keys are to be loaded/used directly from the host microcontroller, type_ax_index is set to 0 by default and the implementation remains backward compatible without using A71CH. Where applicable, the ALT implementation refers to this index to use cryptographic operations from A71CH using those indexes.</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;### Associating keys {#asso_key}</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;The set of APIs for associating keys with relevant context is exposed in ax_mbedtls.h file.</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;###    Public Keys {#pub_key}</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;For cases when we want to use A71CH to use itâ€™s public keys, API to be used is @ref ax_mbedtls_associate_pubkey (e.g. signature verification). For embedded application, this API call is akin to mbedtls_pk_parse_key and similar family of APIs.</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;###    Private Keys {#priv_key}</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;For cases when we want to use A71CH to use itâ€™s private keys (e.g. signing). APIs are listed in @ref ax_mbedtls_associate_pubkey. For embedded application, this API call is akin to mbedtls_pk_parse_key and similar family of APIs.</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;###    TLS ECDH handshake{#tls_ecdh_handshake}</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;During TLS handhake, after setup of ssl context (API call to mbedtls_ssl_setup) use has to call @ref ax_mbedtls_associate_ecdhctx to associate private key to be used during exchange. This would enable the usage of the private key of A71CH to compute shared secret.</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;### Existing middleware/wrappers {#existing_middleware}</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;Some existing middleware written on top of mbed TLS already expect user to create global constants with keys to be used during TLS Negotiation, or full keys (either in PEM or DER Format) are passed to mbed TLS. For such middleware, the approach for enable for A71CH can be to use key length of 1.</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;e.g. for `middleware\aws_iot\platform\lwip\network_mbedtls_wrapper.c`</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;Usage by Middleware (`network_mbedtls_wrapper.c`):</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;\code{.c}</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;    /* Private key */</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;    extern const unsigned char privKey[];</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;    extern const size_t lenPrivKey;</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;\endcode</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;Middleware now expects privKey and lenPrivKey to be set by application:  Application can do as below \.</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;\code{.c}</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;    /* Private key */</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;    const unsigned char privKey[] = {AWS_IOT_KEYS_INDEX_SM};</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;    const size_t lenPrivKey = sizeof(privKey);</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;\endcode</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;Now, the middleware can take hint that lenPrivate key is only 1 and hence this must be associated/used from the A71CH.</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;\code{.c}</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;    if (lenPrivKey == 1) {</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;        ax_mbedtls_associate_ecdhctx(</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;            privKey[0], tlsDataParams-&gt;ssl.handshake );</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;    }</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;\endcode</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;The above approach can be extrapolated for other such middleware as well.</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;## Certificates {#cert}</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;Just as described in case of associating keys from the A71CH, the GP storage inside the A71CH can also be used to store/use certificates.</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;e.g. for `middleware\aws_iot\platform\lwip\network_mbedtls_wrapper.c`</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;Usage by Middleware (network_mbedtls_wrapper.c):</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;\code{.c}</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;    /* Device certificate */</div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;    extern const unsigned char certClient[];</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;    extern const size_t lenCertClient;</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;\endcode</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;Middleware now expects privKey and lenPrivKey to be set by application:  Application can do as below.</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;\code{.c}</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;    /* Device certificate */</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;    const unsigned char certClient[] = {</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;        0x00,0x00,</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;        // Starting address in GP Storage.</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;        // (Little Endian Format)</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;    };</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;    const size_t lenCertClient = sizeof(certClient);</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;\endcode</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;Now, the middleware can take hint that lenPrivate key is only 1 and hence this must be associated/used from the A71CH.</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;\code{.c}</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;    if (lenCertClient == 2) {</div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;        // Possibly certificate is in GP Storage</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;        SM_Error_t ret_code;</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;        uint16_t start_addr;</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;        uint16_t crt_len;</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;        // Assuming 500 bytes maximum for certificate</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;        uint8_t aclient_cer[500];</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;        uint8_t certPattern[] = {0x30, 0x82};</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;        // Calculate address of that certificate</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;        start_addr = certClient[1];</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;        start_addr = start_addr &lt;&lt; 8;</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;        start_addr |= certClient[0];</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;        // Read 1st 4 bytes to vaguely detect if it&#39;s valid</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;        // certificate and it&#39;s length</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;        ret_code = A71_GetGpData(start_addr, aclient_cer, 4);</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;        if ((aclient_cer[0] == certPattern[0])</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;            &amp;&amp; (aclient_cer[1] == certPattern[1]))</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;        {</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;            /* OK */</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;        }</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;        else</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;        {</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;            printf(&quot;No certificate found on offset 0x%04X.\r\n&quot;, start_addr);</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;            return FAILURE;</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;        }</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;        crt_len = 4 + (aclient_cer[2] &lt;&lt; 8) + aclient_cer[3];</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;        if (crt_len &gt; sizeof(aclient_cer)) {</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;            // Provided buffer is too small to contain certificate</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;            printf( &quot;Provided certificate buffer too small: Provided=%d &lt;&gt; Required=%d.\r\n&quot;,sizeof(aclient_cer), crt_len);</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;            return FAILURE;</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;        }</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;        // Read certificate from GP Storage</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;        ret_code = A71_GetGpData(start_addr, aclient_cer, crt_len);</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;        if(SW_OK != ret_code)</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;        {</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;            IOT_ERROR(&quot; failed\n  ! GP read failed\n\r\n&quot;);</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;        }</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;        ret = mbedtls_x509_crt_parse_der(&amp;(tlsDataParams-&gt;clicert), aclient_cer, crt_len);</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;        //...</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;        //...</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;\endcode</div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;The above approach can be extrapolated for other such middleware as well.</div></div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><b>mbedtls_integration.md</b></li>
    <li class="footer">Generated on Fri Sep 7 2018 19:24:06 for A71CH Host Sw by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
