<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>A71CH Host Sw: gen_dox/sci2c_info.md Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">A71CH Host Sw
   &#160;<span id="projectnumber">v01.05.00</span>
   </div>
   <div id="projectbrief">NXP Semiconductors</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('sci2c__info_8md.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">gen_dox/sci2c_info.md</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;# SCI2C on Host Platform {#page_sci2c_info}</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;- DocRevision : 0.90</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;- Date        : 2018-02-09</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;Host Platform specific information on the SCI2C protocol.</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;# (1) Introduction</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;The Host SW contains an SCI2C protocol implementation (`hostLib/libCommon/sci2c.*` wrapped inside `hostLib/libCommon/smComSCI2C.*`).</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;To ensure compatibility with SCI2C, the host platform’s I2C driver needs to support:</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;- Block read (i.e. the response length is encoded in the first byte of the response; a feature typically associated with SMBUS)</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;- Repeated start</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;The SCI2C protocol used by the A71CH is described in full in: \n</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;SCI2C Protocol Specification Rev 1.5 or later (restricted to 1.x Revision, NOT compatible with Rev. 2.x)</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;# (2) SCI2C on MCIMX6UL-EVK</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;We use the standard I2C driver that comes bundled with Yocto for the i.MX6 platform. In Linux the I2C driver implementation is layered. The top-level layer is contained in a file called ‘i2c-dev.c’ and is called the ‘I2C device driver’. The bottom layer deals with the specific hardware of the I2C controller and is specific to the processor or board used, it is called the ‘I2C bus driver’. In case of the MCIMX6UL-EVK board the bus driver is contained in a file called ‘i2c-imx.c’.</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;The following code fragment highlights the correct invocation of the standard I2C driver to enable the Repeated Start and Block Read features.</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;</div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;By passing the two message structures via the packets structure as a parameter to the ioctl call one ensures a Repeated Start is triggered.</div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;By setting the \p ‘I2C_M_RECV_LEN’ bit in \p ‘messages[1].flags’ one ensures the usage of the Block Read feature. Because the Block Read feature is requested the \p ‘len’ and \p ‘buf[0]’ field values of the \p messages[1] structure need special attention:</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;- \p message[1].len is first interpreted by the I2C device driver as the size of the buffer (pRx) provided by the caller. This value MUST be at least 33, a condition fulfilled by providing a buffer of 256 byte.</div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;- The value contained in \p messages[1].buf[0] must be at least ‘1’. On the i.MX6 the value MUST be ‘1’.</div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;If both conditions above are met, the I2C device driver will replace the value of \p message[1].len by the value contained in \p messages[1].buf[0] (i.e. ‘1’). Only then the platform specific I2C bus driver is invoked.</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;    ..</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;    messages[0].addr = axSmDevice_addr;</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;    messages[0].flags = 0;</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;    messages[0].len = txLen;</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;    messages[0].buf = pTx;</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;    messages[1].addr = axSmDevice_addr;</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;    messages[1].flags = I2C_M_RD | I2C_M_RECV_LEN;</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;    messages[1].len = 256;</div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;    messages[1].buf = pRx;</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;    messages[1].buf[0] = 1;</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;    /* Send the request to the kernel and get the result back */</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;    packets.msgs = messages;</div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;    packets.nmsgs = 2;</div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;    r = ioctl(axSmDevice, I2C_RDWR, &amp;packets);</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;    ..</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;</div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;    (1) Code fragment from hostLib/platform/imx/i2c_a7.c illustrating correct I2C driver invocation (on i.MX6)</div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;Furthermore one needs to ensure the packet size on the bus is set correctly during the initial SCI2C Parameter Exchange. By defining ‘PLATFORM_IMX’ at compilation time the correct packet size is set. \n</div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;The following code fragment highlights the specific section of the source code.</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;    ..</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;    #ifdef PLATFORM_IMX</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;    #define SMCOM_MAX_BYTES (eMax31BytesS2M)</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;    #else</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;    #define SMCOM_MAX_BYTES (eMax254BytesS2M)</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;    #endif</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;    ..</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;    (2) Code fragment from hostLib/libCommon/smCom/sci2c_cfg.h Maximum packet size for SCI2C Slave-to-Master transfers (on i.MX6)</div></div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><b>sci2c_info.md</b></li>
    <li class="footer">Generated on Fri Sep 7 2018 19:24:06 for A71CH Host Sw by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
