<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>A71CH Host Sw: SCI2C on Host Platform</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">A71CH Host Sw
   &#160;<span id="projectnumber">v01.05.00</span>
   </div>
   <div id="projectbrief">NXP Semiconductors</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('page_sci2c_info.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">SCI2C on Host Platform </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ul>
<li>DocRevision : 0.90</li>
<li>Date : 2018-02-09</li>
</ul>
<p>Host Platform specific information on the SCI2C protocol.</p>
<h1><a class="anchor" id="autotoc_md66"></a>
(1) Introduction</h1>
<p>The Host SW contains an SCI2C protocol implementation (<code>hostLib/libCommon/sci2c.*</code> wrapped inside <code>hostLib/libCommon/smComSCI2C.*</code>). To ensure compatibility with SCI2C, the host platform’s I2C driver needs to support:</p>
<ul>
<li>Block read (i.e. the response length is encoded in the first byte of the response; a feature typically associated with SMBUS)</li>
<li>Repeated start</li>
</ul>
<p>The SCI2C protocol used by the A71CH is described in full in: <br />
 SCI2C Protocol Specification Rev 1.5 or later (restricted to 1.x Revision, NOT compatible with Rev. 2.x)</p>
<h1><a class="anchor" id="autotoc_md67"></a>
(2) SCI2C on MCIMX6UL-EVK</h1>
<p>We use the standard I2C driver that comes bundled with Yocto for the i.MX6 platform. In Linux the I2C driver implementation is layered. The top-level layer is contained in a file called ‘i2c-dev.c’ and is called the ‘I2C device driver’. The bottom layer deals with the specific hardware of the I2C controller and is specific to the processor or board used, it is called the ‘I2C bus driver’. In case of the MCIMX6UL-EVK board the bus driver is contained in a file called ‘i2c-imx.c’.</p>
<p>The following code fragment highlights the correct invocation of the standard I2C driver to enable the Repeated Start and Block Read features.</p>
<p>By passing the two message structures via the packets structure as a parameter to the ioctl call one ensures a Repeated Start is triggered.</p>
<p>By setting the <code>‘I2C_M_RECV_LEN’</code> bit in <code>‘messages</code>[1].flags’ one ensures the usage of the Block Read feature. Because the Block Read feature is requested the <code>‘len’</code> and <code>‘buf</code>[0]’ field values of the <code>messages</code>[1] structure need special attention:</p>
<ul>
<li><code>message</code>[1].len is first interpreted by the I2C device driver as the size of the buffer (pRx) provided by the caller. This value MUST be at least 33, a condition fulfilled by providing a buffer of 256 byte.</li>
<li>The value contained in <code>messages</code>[1].buf[0] must be at least ‘1’. On the i.MX6 the value MUST be ‘1’.</li>
</ul>
<p>If both conditions above are met, the I2C device driver will replace the value of <code>message</code>[1].len by the value contained in <code>messages</code>[1].buf<a href="i.e. ‘1’">0</a>. Only then the platform specific I2C bus driver is invoked. </p><pre class="fragment">..
messages[0].addr = axSmDevice_addr;
messages[0].flags = 0;
messages[0].len = txLen;
messages[0].buf = pTx;
messages[1].addr = axSmDevice_addr;
messages[1].flags = I2C_M_RD | I2C_M_RECV_LEN;
messages[1].len = 256;
messages[1].buf = pRx;
messages[1].buf[0] = 1;
/* Send the request to the kernel and get the result back */
packets.msgs = messages;
packets.nmsgs = 2;
r = ioctl(axSmDevice, I2C_RDWR, &amp;packets);
..

(1) Code fragment from hostLib/platform/imx/i2c_a7.c illustrating correct I2C driver invocation (on i.MX6)
</pre><p>Furthermore one needs to ensure the packet size on the bus is set correctly during the initial SCI2C Parameter Exchange. By defining ‘PLATFORM_IMX’ at compilation time the correct packet size is set. <br />
The following code fragment highlights the specific section of the source code. </p><pre class="fragment">..
#ifdef PLATFORM_IMX
#define SMCOM_MAX_BYTES (eMax31BytesS2M)
#else
#define SMCOM_MAX_BYTES (eMax254BytesS2M)
#endif
..

(2) Code fragment from hostLib/libCommon/smCom/sci2c_cfg.h Maximum packet size for SCI2C Slave-to-Master transfers (on i.MX6)</pre> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="page_platform.html">Platform</a></li>
    <li class="footer">Generated on Fri Sep 7 2018 19:24:07 for A71CH Host Sw by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
